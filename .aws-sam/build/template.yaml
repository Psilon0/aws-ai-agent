AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "FinSense \u2014 Serverless stack (API \u2192 Lambda) with DynamoDB,\
  \ Bedrock permissions, and X-Ray."
Parameters:
  DdbTableName:
    Type: String
    Default: agent_sessions
  Env:
    Type: String
    Default: dev
  LogLevel:
    Type: String
    Default: INFO
Globals:
  Function:
    Runtime: python3.11
    Timeout: 30
    MemorySize: 512
    Tracing: Active
    Architectures:
    - arm64
    Environment:
      Variables:
        ENV:
          Ref: Env
        LOG_LEVEL:
          Ref: LogLevel
        DDB_SESSION_TABLE:
          Ref: DdbTableName
        USE_XRAY: '1'
        XRAY_SERVICE_NAME: FinSense
Resources:
  AgentSessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Ref: DdbTableName
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: session_id
        AttributeType: S
      KeySchema:
      - AttributeName: session_id
        KeyType: HASH
  FinSenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: FinSenseFunction
      Handler: src/lambda_handler.handler
      Policies:
      - AWSXRayDaemonWriteAccess
      - DynamoDBCrudPolicy:
          TableName:
            Ref: DdbTableName
      - Statement:
          Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          Resource: '*'
      Events:
        Run:
          Type: HttpApi
          Properties:
            Path: /run
            Method: POST
    Metadata:
      SamResourceId: FinSenseFunction
Outputs:
  HttpApiUrl:
    Description: Base URL for the HTTP API
    Value:
      Fn::Sub: https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com
