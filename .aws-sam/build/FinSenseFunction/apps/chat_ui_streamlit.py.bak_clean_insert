import re
from typing import Dict, Any, List, Optional
import requests
import streamlit as st
import matplotlib.pyplot as plt

st.set_page_config(

def parse_overrides(text: str) -> dict:
    """
    Extract age, risk, horizon, amount(£), and % intent from free text.
    Examples:
      "55 years old", "high/aggressive", "low/conservative/safe/defensive",
      "14 years" / "7y", "£3,000.25", "3000 pounds", "invest 35401", "save 10%".
    """
    text_l = (text or "").lower()
    out: Dict[str, Any] = {}

    # Age
    m_age = re.search(r'(?:^|\D)(1[6-9]|[2-9]\d|100)\s*year(?:s)?\s*old\b', text_l)
    if m_age:
        out["age"] = int(m_age.group(1))

    # Risk
    if re.search(r'\b(high\s*risk|aggressive|growthy|risk[-\s]*seeking)\b', text_l):
        out["risk"] = "aggressive"
    elif re.search(r'\b(moderate|balanced)\b', text_l):
        out["risk"] = "moderate"
    elif re.search(r'\b(low\s*risk|conservative|defensive|safe)\b', text_l):
        out["risk"] = "conservative"

    # Horizon
    m_h = re.search(r'\b(1|[2-3]?\d)\s*(?:y|yr|yrs|year|years)\b', text_l)
    if m_h:
        out["horizon_years"] = int(m_h.group(1))

    # Amount (GBP)
    text_norm = text_l.replace(",", "")
    m_amt = (
        re.search(r'£\s*([0-9]+(?:\.[0-9]{1,2})?)', text_norm)
        or re.search(r'([0-9]+(?:\.[0-9]{1,2})?)\s*(pounds|gbp)\b', text_norm)
        or re.search(r'\binvest\s+([0-9]+(?:\.[0-9]{1,2})?)\b', text_norm)
    )
    if m_amt:
        try:
            out["amount_gbp"] = float(m_amt.group(1))
        except Exception:
            pass

    # Percent intent (save/invest N%)
    m_pct = re.search(r'(\d{1,2}(?:\.\d+)?)\s*%', text_norm) or re.search(r'(\d{1,2}(?:\.\d+)?)\s*percent', text_norm)
    if m_pct:
        try:
            out["percent_intent"] = float(m_pct.group(1))
        except Exception:
            pass

    return out
